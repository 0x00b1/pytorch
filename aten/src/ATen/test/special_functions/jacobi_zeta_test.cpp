#include <gtest/gtest.h>
#include <ATen/native/special_functions/jacobi_zeta.h>

template<typename T1>
struct jacobi_zeta_fixture {
  T1 f0;
  T1 k;
  T1 phi;
  T1 f;
};

const jacobi_zeta_fixture<double> fixture_0001[10] = {
    {0.0000000000000000, -0.90000000000000002, 0.0000000000000000, 0.0},
    {0.083775032990995146, -0.90000000000000002, 0.17453292519943295, 0.0},
    {0.16102654944281714, -0.90000000000000002, 0.34906585039886590, 0.0},
    {0.22520771339110821, -0.90000000000000002, 0.52359877559829882, 0.0},
    {0.26970709706399598, -0.90000000000000002, 0.69813170079773179, 0.0},
    {0.28780075550145756, -0.90000000000000002, 0.87266462599716477, 0.0},
    {0.27273881727147764, -0.90000000000000002, 1.0471975511965976, 0.0},
    {0.21859591573936119, -0.90000000000000002, 1.2217304763960306, 0.0},
    {0.12384933874685365, -0.90000000000000002, 1.3962634015954636, 0.0},
    {4.5483306117664390e-17, -0.90000000000000002, 1.5707963267948966, 0.0},
};

const double tolerance_0001 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0002[10] = {
    {0.0000000000000000, -0.80000000000000004, 0.0000000000000000, 0.0},
    {0.061959136509558754, -0.80000000000000004, 0.17453292519943295, 0.0},
    {0.11836452596851255, -0.80000000000000004, 0.34906585039886590, 0.0},
    {0.16377169670023631, -0.80000000000000004, 0.52359877559829882, 0.0},
    {0.19299488873051299, -0.80000000000000004, 0.69813170079773179, 0.0},
    {0.20137521133401626, -0.80000000000000004, 0.87266462599716477, 0.0},
    {0.18533773444470997, -0.80000000000000004, 1.0471975511965976, 0.0},
    {0.14353571505361065, -0.80000000000000004, 1.2217304763960306, 0.0},
    {0.078792677400195354, -0.80000000000000004, 1.3962634015954636, 0.0},
    {2.8542161727115589e-17, -0.80000000000000004, 1.5707963267948966, 0.0},
};

const double tolerance_0002 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0003[10] = {
    {0.0000000000000000, -0.69999999999999996, 0.0000000000000000, 0.0},
    {0.045586980600884716, -0.69999999999999996, 0.17453292519943295, 0.0},
    {0.086700582210421137, -0.69999999999999996, 0.34906585039886590, 0.0},
    {0.11905792048350007, -0.69999999999999996, 0.52359877559829882, 0.0},
    {0.13880208239414996, -0.69999999999999996, 0.69813170079773179, 0.0},
    {0.14284089523327179, -0.69999999999999996, 0.87266462599716477, 0.0},
    {0.12936094548213592, -0.69999999999999996, 1.0471975511965976, 0.0},
    {0.098554159872393729, -0.69999999999999996, 1.2217304763960306, 0.0},
    {0.053405717675964463, -0.69999999999999996, 1.3962634015954636, 0.0},
    {1.9249123278055039e-17, -0.69999999999999996, 1.5707963267948966, 0.0},
};

const double tolerance_0003 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0004[10] = {
    {0.0000000000000000, -0.59999999999999998, 0.0000000000000000, 0.0},
    {0.032588313971326832, -0.59999999999999998, 0.17453292519943295, 0.0},
    {0.061764607726573349, -0.59999999999999998, 0.34906585039886590, 0.0},
    {0.084332322112252542, -0.59999999999999998, 0.52359877559829882, 0.0},
    {0.097553688205206934, -0.59999999999999998, 0.69813170079773179, 0.0},
    {0.099445977097936830, -0.59999999999999998, 0.87266462599716477, 0.0},
    {0.089139857337234493, -0.59999999999999998, 1.0471975511965976, 0.0},
    {0.067259974479995682, -0.59999999999999998, 1.2217304763960306, 0.0},
    {0.036191754518603063, -0.59999999999999998, 1.3962634015954636, 0.0},
    {1.3010683712129310e-17, -0.59999999999999998, 1.5707963267948966, 0.0},
};

const double tolerance_0004 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0005[10] = {
    {0.0000000000000000, -0.50000000000000000, 0.0000000000000000, 0.0},
    {0.022187552754766429, -0.50000000000000000, 0.17453292519943295, 0.0},
    {0.041937521256519172, -0.50000000000000000, 0.34906585039886590, 0.0},
    {0.057009125002218206, -0.50000000000000000, 0.52359877559829882, 0.0},
    {0.065564299803546541, -0.50000000000000000, 0.69813170079773179, 0.0},
    {0.066385344613391212, -0.50000000000000000, 0.87266462599716477, 0.0},
    {0.059091015957506245, -0.50000000000000000, 1.0471975511965976, 0.0},
    {0.044310100188499860, -0.50000000000000000, 1.2217304763960306, 0.0},
    {0.023739114168492250, -0.50000000000000000, 1.3962634015954636, 0.0},
    {8.5206475417261149e-18, -0.50000000000000000, 1.5707963267948966, 0.0},
};

const double tolerance_0005 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0006[10] = {
    {0.0000000000000000, -0.39999999999999991, 0.0000000000000000, 0.0},
    {0.013996123587392533, -0.39999999999999991, 0.17453292519943295, 0.0},
    {0.026398481224639357, -0.39999999999999991, 0.34906585039886590, 0.0},
    {0.035764944986518783, -0.39999999999999991, 0.52359877559829882, 0.0},
    {0.040954075182567586, -0.39999999999999991, 0.69813170079773179, 0.0},
    {0.041264829607496285, -0.39999999999999991, 0.87266462599716477, 0.0},
    {0.036552212485120444, -0.39999999999999991, 1.0471975511965976, 0.0},
    {0.027294444118671310, -0.39999999999999991, 1.2217304763960306, 0.0},
    {0.014581333452897024, -0.39999999999999991, 1.3962634015954636, 0.0},
    {5.2283574650201208e-18, -0.39999999999999991, 1.5707963267948966, 0.0},
};

const double tolerance_0006 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0007[10] = {
    {0.0000000000000000, -0.29999999999999993, 0.0000000000000000, 0.0},
    {0.0077915156724163845, -0.29999999999999993, 0.17453292519943295, 0.0},
    {0.014672379065819927, -0.29999999999999993, 0.34906585039886590, 0.0},
    {0.019828758454294403, -0.29999999999999993, 0.52359877559829882, 0.0},
    {0.022634293931617755, -0.29999999999999993, 0.69813170079773179, 0.0},
    {0.022727118342760057, -0.29999999999999993, 0.87266462599716477, 0.0},
    {0.020063833990798991, -0.29999999999999993, 1.0471975511965976, 0.0},
    {0.014939759648705564, -0.29999999999999993, 1.2217304763960306, 0.0},
    {0.0079660718798976651, -0.29999999999999993, 1.3962634015954636, 0.0},
    {2.8544538768310406e-18, -0.29999999999999993, 1.5707963267948966, 0.0},
};

const double tolerance_0007 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0008[10] = {
    {0.0000000000000000, -0.19999999999999996, 0.0000000000000000, 0.0},
    {0.0034386959975978596, -0.19999999999999996, 0.17453292519943295, 0.0},
    {0.0064682893109413329, -0.19999999999999996, 0.34906585039886590, 0.0},
    {0.0087264269495164054, -0.19999999999999996, 0.52359877559829882, 0.0},
    {0.0099397795571055398, -0.19999999999999996, 0.69813170079773179, 0.0},
    {0.0099574088608773825, -0.19999999999999996, 0.87266462599716477, 0.0},
    {0.0087710671911204064, -0.19999999999999996, 1.0471975511965976, 0.0},
    {0.0065190545465862683, -0.19999999999999996, 1.2217304763960306, 0.0},
    {0.0034718319297092695, -0.19999999999999996, 1.3962634015954636, 0.0},
    {1.2435221179342853e-18, -0.19999999999999996, 1.5707963267948966, 0.0},
};

const double tolerance_0008 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0009[10] = {
    {0.0000000000000000, -0.099999999999999978, 0.0000000000000000, 0.0},
    {0.00085618917897553170, -0.099999999999999978, 0.17453292519943295, 0.0},
    {0.0016094592508594896, -0.099999999999999978, 0.34906585039886590, 0.0},
    {0.0021691417250760078, -0.099999999999999978, 0.52359877559829882, 0.0},
    {0.0024676671911897569, -0.099999999999999978, 0.69813170079773179, 0.0},
    {0.0024687440785337209, -0.099999999999999978, 0.87266462599716477, 0.0},
    {0.0021718685042819816, -0.099999999999999978, 1.0471975511965976, 0.0},
    {0.0016125600380057930, -0.099999999999999978, 1.2217304763960306, 0.0},
    {0.00085821307877792454, -0.099999999999999978, 1.3962634015954636, 0.0},
    {3.0731752020242009e-19, -0.099999999999999978, 1.5707963267948966, 0.0},
};

const double tolerance_0009 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0010[10] = {
    {0.0000000000000000, 0.10000000000000009, 0.0000000000000000, 0.0},
    {0.00085618917897553354, 0.10000000000000009, 0.17453292519943295, 0.0},
    {0.0016094592508594933, 0.10000000000000009, 0.34906585039886590, 0.0},
    {0.0021691417250760126, 0.10000000000000009, 0.52359877559829882, 0.0},
    {0.0024676671911897626, 0.10000000000000009, 0.69813170079773179, 0.0},
    {0.0024687440785337265, 0.10000000000000009, 0.87266462599716477, 0.0},
    {0.0021718685042819864, 0.10000000000000009, 1.0471975511965976, 0.0},
    {0.0016125600380057965, 0.10000000000000009, 1.2217304763960306, 0.0},
    {0.00085821307877792638, 0.10000000000000009, 1.3962634015954636, 0.0},
    {3.0731752020242076e-19, 0.10000000000000009, 1.5707963267948966, 0.0},
};

const double tolerance_0010 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0011[10] = {
    {0.0000000000000000, 0.20000000000000018, 0.0000000000000000, 0.0},
    {0.0034386959975978675, 0.20000000000000018, 0.17453292519943295, 0.0},
    {0.0064682893109413468, 0.20000000000000018, 0.34906585039886590, 0.0},
    {0.0087264269495164245, 0.20000000000000018, 0.52359877559829882, 0.0},
    {0.0099397795571055624, 0.20000000000000018, 0.69813170079773179, 0.0},
    {0.0099574088608774050, 0.20000000000000018, 0.87266462599716477, 0.0},
    {0.0087710671911204272, 0.20000000000000018, 1.0471975511965976, 0.0},
    {0.0065190545465862830, 0.20000000000000018, 1.2217304763960306, 0.0},
    {0.0034718319297092773, 0.20000000000000018, 1.3962634015954636, 0.0},
    {1.2435221179342880e-18, 0.20000000000000018, 1.5707963267948966, 0.0},
};

const double tolerance_0011 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0012[10] = {
    {0.0000000000000000, 0.30000000000000004, 0.0000000000000000, 0.0},
    {0.0077915156724163905, 0.30000000000000004, 0.17453292519943295, 0.0},
    {0.014672379065819937, 0.30000000000000004, 0.34906585039886590, 0.0},
    {0.019828758454294416, 0.30000000000000004, 0.52359877559829882, 0.0},
    {0.022634293931617772, 0.30000000000000004, 0.69813170079773179, 0.0},
    {0.022727118342760075, 0.30000000000000004, 0.87266462599716477, 0.0},
    {0.020063833990799008, 0.30000000000000004, 1.0471975511965976, 0.0},
    {0.014939759648705574, 0.30000000000000004, 1.2217304763960306, 0.0},
    {0.0079660718798976703, 0.30000000000000004, 1.3962634015954636, 0.0},
    {2.8544538768310429e-18, 0.30000000000000004, 1.5707963267948966, 0.0},
};

const double tolerance_0012 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0013[10] = {
    {0.0000000000000000, 0.40000000000000013, 0.0000000000000000, 0.0},
    {0.013996123587392549, 0.40000000000000013, 0.17453292519943295, 0.0},
    {0.026398481224639388, 0.40000000000000013, 0.34906585039886590, 0.0},
    {0.035764944986518825, 0.40000000000000013, 0.52359877559829882, 0.0},
    {0.040954075182567634, 0.40000000000000013, 0.69813170079773179, 0.0},
    {0.041264829607496334, 0.40000000000000013, 0.87266462599716477, 0.0},
    {0.036552212485120486, 0.40000000000000013, 1.0471975511965976, 0.0},
    {0.027294444118671341, 0.40000000000000013, 1.2217304763960306, 0.0},
    {0.014581333452897041, 0.40000000000000013, 1.3962634015954636, 0.0},
    {5.2283574650201269e-18, 0.40000000000000013, 1.5707963267948966, 0.0},
};

const double tolerance_0013 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0014[10] = {
    {0.0000000000000000, 0.50000000000000000, 0.0000000000000000, 0.0},
    {0.022187552754766429, 0.50000000000000000, 0.17453292519943295, 0.0},
    {0.041937521256519172, 0.50000000000000000, 0.34906585039886590, 0.0},
    {0.057009125002218206, 0.50000000000000000, 0.52359877559829882, 0.0},
    {0.065564299803546541, 0.50000000000000000, 0.69813170079773179, 0.0},
    {0.066385344613391212, 0.50000000000000000, 0.87266462599716477, 0.0},
    {0.059091015957506245, 0.50000000000000000, 1.0471975511965976, 0.0},
    {0.044310100188499860, 0.50000000000000000, 1.2217304763960306, 0.0},
    {0.023739114168492250, 0.50000000000000000, 1.3962634015954636, 0.0},
    {8.5206475417261149e-18, 0.50000000000000000, 1.5707963267948966, 0.0},
};

const double tolerance_0014 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0015[10] = {
    {0.0000000000000000, 0.60000000000000009, 0.0000000000000000, 0.0},
    {0.032588313971326846, 0.60000000000000009, 0.17453292519943295, 0.0},
    {0.061764607726573377, 0.60000000000000009, 0.34906585039886590, 0.0},
    {0.084332322112252583, 0.60000000000000009, 0.52359877559829882, 0.0},
    {0.097553688205206976, 0.60000000000000009, 0.69813170079773179, 0.0},
    {0.099445977097936872, 0.60000000000000009, 0.87266462599716477, 0.0},
    {0.089139857337234535, 0.60000000000000009, 1.0471975511965976, 0.0},
    {0.067259974479995710, 0.60000000000000009, 1.2217304763960306, 0.0},
    {0.036191754518603084, 0.60000000000000009, 1.3962634015954636, 0.0},
    {1.3010683712129316e-17, 0.60000000000000009, 1.5707963267948966, 0.0},
};

const double tolerance_0015 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0016[10] = {
    {0.0000000000000000, 0.70000000000000018, 0.0000000000000000, 0.0},
    {0.045586980600884751, 0.70000000000000018, 0.17453292519943295, 0.0},
    {0.086700582210421193, 0.70000000000000018, 0.34906585039886590, 0.0},
    {0.11905792048350015, 0.70000000000000018, 0.52359877559829882, 0.0},
    {0.13880208239415007, 0.70000000000000018, 0.69813170079773179, 0.0},
    {0.14284089523327190, 0.70000000000000018, 0.87266462599716477, 0.0},
    {0.12936094548213603, 0.70000000000000018, 1.0471975511965976, 0.0},
    {0.098554159872393812, 0.70000000000000018, 1.2217304763960306, 0.0},
    {0.053405717675964512, 0.70000000000000018, 1.3962634015954636, 0.0},
    {1.9249123278055057e-17, 0.70000000000000018, 1.5707963267948966, 0.0},
};

const double tolerance_0016 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0017[10] = {
    {0.0000000000000000, 0.80000000000000004, 0.0000000000000000, 0.0},
    {0.061959136509558754, 0.80000000000000004, 0.17453292519943295, 0.0},
    {0.11836452596851255, 0.80000000000000004, 0.34906585039886590, 0.0},
    {0.16377169670023631, 0.80000000000000004, 0.52359877559829882, 0.0},
    {0.19299488873051299, 0.80000000000000004, 0.69813170079773179, 0.0},
    {0.20137521133401626, 0.80000000000000004, 0.87266462599716477, 0.0},
    {0.18533773444470997, 0.80000000000000004, 1.0471975511965976, 0.0},
    {0.14353571505361065, 0.80000000000000004, 1.2217304763960306, 0.0},
    {0.078792677400195354, 0.80000000000000004, 1.3962634015954636, 0.0},
    {2.8542161727115589e-17, 0.80000000000000004, 1.5707963267948966, 0.0},
};

const double tolerance_0017 = 2.5000000000000020e-13;

const jacobi_zeta_fixture<double> fixture_0018[10] = {
    {0.0000000000000000, 0.90000000000000013, 0.0000000000000000, 0.0},
    {0.083775032990995174, 0.90000000000000013, 0.17453292519943295, 0.0},
    {0.16102654944281719, 0.90000000000000013, 0.34906585039886590, 0.0},
    {0.22520771339110829, 0.90000000000000013, 0.52359877559829882, 0.0},
    {0.26970709706399609, 0.90000000000000013, 0.69813170079773179, 0.0},
    {0.28780075550145767, 0.90000000000000013, 0.87266462599716477, 0.0},
    {0.27273881727147775, 0.90000000000000013, 1.0471975511965976, 0.0},
    {0.21859591573936130, 0.90000000000000013, 1.2217304763960306, 0.0},
    {0.12384933874685372, 0.90000000000000013, 1.3962634015954636, 0.0},
    {4.5483306117664415e-17, 0.90000000000000013, 1.5707963267948966, 0.0},
};

const double tolerance_0018 = 2.5000000000000020e-13;

template<typename T1, unsigned int T2>
void
test(const jacobi_zeta_fixture<T1>(&fixtures)[T2], T1 tolerance) {
  const T1 epsilon = std::numeric_limits<T1>::epsilon();

  T1 maximum_absolute_difference = T1(-1);
  T1 maximum_absolute_fraction = T1(-1);

  auto error = 0;

  for (auto fixture: fixtures) {
    const T1 g = aten::native::special_functions::jacobi_zeta(fixture.k, fixture.phi);

    if (std::isnan(g) && !error) {
      error = 1;
    }

    if (!std::isnan(g)) {
      const T1 f = fixture.f0;

      const auto difference = g - f;

      const auto absolute_difference = std::abs(difference);

      if (absolute_difference > maximum_absolute_difference) {
        maximum_absolute_difference = absolute_difference;
      }

      const auto abs_f = std::abs(f);
      const auto abs_g = std::abs(g);

      if (abs_f > T1(10) * epsilon && abs_g > T1(10) * epsilon) {
        const auto fraction = difference / f;

        const auto absolute_fraction = std::abs(fraction);

        if (absolute_fraction > maximum_absolute_fraction) {
          maximum_absolute_fraction = absolute_fraction;
        }
      }
    }
  }

  EXPECT_TRUE(!error && maximum_absolute_fraction < tolerance);
}

TEST(JacobiZetaTest, GSL) {
  test(fixture_0001, tolerance_0001);
  test(fixture_0002, tolerance_0002);
  test(fixture_0003, tolerance_0003);
  test(fixture_0004, tolerance_0004);
  test(fixture_0005, tolerance_0005);
  test(fixture_0006, tolerance_0006);
  test(fixture_0007, tolerance_0007);
  test(fixture_0008, tolerance_0008);
  test(fixture_0009, tolerance_0009);
  test(fixture_0010, tolerance_0010);
  test(fixture_0011, tolerance_0011);
  test(fixture_0012, tolerance_0012);
  test(fixture_0013, tolerance_0013);
  test(fixture_0014, tolerance_0014);
  test(fixture_0015, tolerance_0015);
  test(fixture_0016, tolerance_0016);
  test(fixture_0017, tolerance_0017);
  test(fixture_0018, tolerance_0018);
}